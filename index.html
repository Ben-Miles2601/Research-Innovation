<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Research Support Sitemap</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Research & Innovation Sitemap</h1>

    <!-- Controls -->
    <div class="flex flex-wrap gap-4 mb-6">
      <button id="treeBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">Tree View</button>
      <button id="sitemapBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700">Sitemap View</button>
      <input id="search" type="search" placeholder="Search..." class="px-4 py-2 border rounded-lg w-64" />
    </div>

    <!-- Container -->
    <div id="visualisation" class="bg-white p-6 rounded-2xl shadow"></div>
  </div>

  <script>
    async function loadData() {
      const res = await fetch('site_data.json');
      return await res.json();
    }

    function renderTree(data) {
      const width = 1000, height = 600;
      const root = d3.hierarchy(data);

      root.dx = 20;
      root.dy = width / (root.height + 2);
      d3.tree().nodeSize([root.dx, root.dy])(root);

      let x0 = Infinity;
      let x1 = -x0;
      root.each(d => {
        if (d.x > x1) x1 = d.x;
        if (d.x < x0) x0 = d.x;
      });

      const svg = d3.create("svg")
        .attr("viewBox", [0, 0, width, x1 - x0 + root.dx * 2])
        .classed("w-full", true);

      const g = svg.append("g").attr("transform", `translate(${root.dy / 3},${root.dx - x0})`);

      // Links
      g.append("g")
        .selectAll("path")
        .data(root.links())
        .join("path")
        .attr("fill", "none")
        .attr("stroke", "#ccc")
        .attr("stroke-width", 2)
        .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

      // Nodes
      const node = g.append("g")
        .selectAll("g")
        .data(root.descendants())
        .join("g")
        .attr("transform", d => `translate(${d.y},${d.x})`);

      node.append("circle")
        .attr("r", 6)
        .attr("fill", d => d.children ? "#2563eb" : "#16a34a")
        .attr("stroke", "#fff")
        .attr("stroke-width", 2);

      node.append("a")
        .attr("href", d => d.data.url || null)
        .attr("target", "_blank")
        .append("text")
        .attr("dy", "0.32em")
        .attr("x", d => d.children ? -10 : 10)
        .attr("text-anchor", d => d.children ? "end" : "start")
        .attr("class", "font-medium text-gray-700 hover:underline")
        .text(d => d.data.name);

      return svg.node();
    }

    function renderSitemap(data) {
      const container = document.createElement('div');
      container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";

      function renderSection(node) {
        const card = document.createElement('div');
        card.className = "p-4 bg-gray-100 rounded-xl shadow hover:shadow-md";

        const title = document.createElement('h2');
        title.className = "text-lg font-semibold mb-3";
        title.textContent = node.name;
        card.appendChild(title);

        if (node.children) {
          const list = document.createElement('ul');
          list.className = "space-y-2";
          node.children.forEach(child => {
            const li = document.createElement('li');
            if (child.url) {
              li.innerHTML = `<a href="${child.url}" target="_blank" class="text-blue-600 hover:underline">${child.name}</a>`;
            } else {
              li.textContent = child.name;
            }
            list.appendChild(li);
          });
          card.appendChild(list);
        }
        return card;
      }

      if (data.children) {
        data.children.forEach(child => {
          container.appendChild(renderSection(child));
        });
      }

      return container;
    }

    function filterTree(node, term) {
      if (!term) return node;
      const match = node.name.toLowerCase().includes(term.toLowerCase());
      if (node.children) {
        const filteredChildren = node.children.map(child => filterTree(child, term)).filter(Boolean);
        if (filteredChildren.length || match) {
          return { ...node, children: filteredChildren };
        }
      }
      return match ? { ...node } : null;
    }

    (async () => {
      const rawData = await loadData();
      let currentMode = 'tree';

      const vis = document.getElementById('visualisation');
      const searchInput = document.getElementById('search');

      function render() {
        vis.innerHTML = '';
        const filtered = filterTree(rawData, searchInput.value);
        if (!filtered) {
          vis.innerHTML = '<p class="text-red-500">No results found</p>';
          return;
        }
        if (currentMode === 'tree') vis.appendChild(renderTree(filtered));
        else vis.appendChild(renderSitemap(filtered));
      }

      document.getElementById('treeBtn').onclick = () => {
        currentMode = 'tree';
        render();
      };
      document.getElementById('sitemapBtn').onclick = () => {
        currentMode = 'sitemap';
        render();
      };
      searchInput.oninput = render;

      render();
    })();
  </script>
</body>
</html>
